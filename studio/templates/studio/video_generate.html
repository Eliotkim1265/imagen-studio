{% extends "studio/base.html" %}
{% load static %}
{% block title %}Generate Video{% endblock %}

{% block content_container %}
<div class="pt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="main-title mb-0">Generate Video</h1>
    </div>
    <p class="text-muted mb-4">Create videos from text prompts, optionally guided by an initial image. Videos are saved to Cloud Storage and may take several minutes to generate.
    <br>For an initial image, you can upload a file, provide a Media Path from your Cloud Storage (e.g., <code>{{ gcs_path_prefix_for_display|default_if_none:"your_media_root/" }}image.png</code>), or choose from your media library.</p>

    <form method="post" enctype="multipart/form-data" class="studio-form p-lg-4 p-3 mb-5" id="videoGenerateForm">
        {% csrf_token %}
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %} <p>{{ error }}</p> {% endfor %}
            </div>
        {% endif %}

        <div class="row">
            <div class="col-lg-5">
                <div class="form-section mb-3 p-3">
                    <h6 class="mb-3">1. Initial Image (Optional)</h6>
                    <label for="{{ form.input_image_upload.id_for_label }}" class="form-label">{{ form.input_image_upload.label }}</label>
                    {{ form.input_image_upload }} {# Actual file input #}
                    <div class="image-preview-container mt-2" id="input_image_upload_preview_container" style="display: none;">
                        <img id="input_image_upload_preview" src="#" alt="Input Image Upload Preview" class="image-preview"/>
                        <button type="button" class="remove-image-btn" onclick="removeImagePreview('{{ form.input_image_upload.id_for_label }}', 'input_image_upload_preview_container', 'input_image_upload_preview')">&times;</button>
                    </div>
                    {% if form.input_image_upload.errors %}<div class="invalid-feedback d-block mt-1">{{ form.input_image_upload.errors.0 }}</div>{% endif %}
                    
                    <div class="my-1 text-center text-muted small fw-bold">OR</div>
                    
                    <label for="{{ form.input_image_media_path.id_for_label }}" class="form-label">{{ form.input_image_media_path.label }}</label>
                    <div class="input-group">
                        {{ form.input_image_media_path }} {# Text input for media path #}
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="openMediaSelector(
                                    '{{ form.input_image_media_path.id_for_label }}',
                                    'input_image_gcs_preview_container',
                                    'input_image_gcs_preview',
                                    'image',  {# For initial Veo image, we list 'image' types #}
                                    '{{ form.input_image_upload.id_for_label }}'
                                )">
                            <span class="material-icons-outlined" style="font-size: 1rem; vertical-align: middle;">folder_open</span> Choose Media
                        </button>
                    </div>
                    <div class="form-text">Path within your Cloud Storage.</div>
                    <div class="image-preview-container mt-2" id="input_image_gcs_preview_container" {% if not input_image_signed_url_for_preview or input_image_signed_url_for_preview|slice:":6" == "#error" %}style="display: none;"{% endif %}>
                        <img id="input_image_gcs_preview" src="{{ input_image_signed_url_for_preview|default:'#' }}" alt="Input Cloud Media Preview" class="image-preview"/>
                        <button type="button" class="remove-image-btn" onclick="removeGCSPreview('{{ form.input_image_media_path.id_for_label }}', 'input_image_gcs_preview_container', 'input_image_gcs_preview')">&times;</button>
                        <p class="small text-muted mt-1" id="input_image_gcs_preview_text" {% if not input_image_signed_url_for_preview or input_image_signed_url_for_preview|slice:":6" == "#error" %}style="display: none;"{% endif %}>Current Cloud Media Preview</p>
                    </div>
                    {% if input_image_signed_url_for_preview and input_image_signed_url_for_preview|slice:":6" == "#error" %}
                         <div class="alert alert-warning small mt-2 p-2">Preview unavailable: {{ input_image_signed_url_for_preview }}</div>
                    {% endif %}
                    {% if form.input_image_media_path.errors %}<div class="invalid-feedback d-block mt-1">{{ form.input_image_media_path.errors.0 }}</div>{% endif %}
                </div>
            </div>

            <div class="col-lg-7">
                <div class="form-section mb-3 p-3">
                    <h6 class="mb-3">2. Video Description & Settings</h6>
                    <label for="{{ form.prompt.id_for_label }}" class="form-label">{{ form.prompt.label }}</label>
                    {{ form.prompt }}
                    {% if form.prompt.errors %}<div class="invalid-feedback d-block mt-1">{{ form.prompt.errors.0 }}</div>{% endif %}
                </div>
                <div class="row">
                    <div class="col-md-6"><div class="form-section mb-3 p-3"><label for="{{ form.aspect_ratio.id_for_label }}" class="form-label">{{ form.aspect_ratio.label }}</label> {{ form.aspect_ratio }} {% if form.aspect_ratio.errors %}<div class="invalid-feedback d-block">{{ form.aspect_ratio.errors.0 }}</div>{% endif %}</div></div>
                    <div class="col-md-6"><div class="form-section mb-3 p-3"><label for="{{ form.person_generation.id_for_label }}" class="form-label">{{ form.person_generation.label }}</label> {{ form.person_generation }} {% if form.person_generation.errors %}<div class="invalid-feedback d-block">{{ form.person_generation.errors.0 }}</div>{% endif %}</div></div>
                </div>
                 <div class="row">
                    <div class="col-sm-6"><div class="form-section mb-3 p-3"><label for="{{ form.sample_count.id_for_label }}" class="form-label">{{ form.sample_count.label }}</label> {{ form.sample_count }} <output class="range-value" for="{{ form.sample_count.id_for_label }}">{{ form.sample_count.value|default_if_none:"1" }}</output> {% if form.sample_count.errors %}<div class="invalid-feedback d-block">{{ form.sample_count.errors.0 }}</div>{% endif %}</div></div>
                    <div class="col-sm-6"><div class="form-section mb-3 p-3"><label for="{{ form.duration_seconds.id_for_label }}" class="form-label">{{ form.duration_seconds.label }}</label> {{ form.duration_seconds }} <output class="range-value" for="{{ form.duration_seconds.id_for_label }}">{{ form.duration_seconds.value|default_if_none:"8" }}</output> {% if form.duration_seconds.errors %}<div class="invalid-feedback d-block">{{ form.duration_seconds.errors.0 }}</div>{% endif %}</div></div>
                </div>
                 <div class="form-section mb-3 p-3">
                    <h6 class="mb-3">Advanced Settings</h6>
                    <div class="form-check form-switch mb-2">
                        {{ form.enable_prompt_rewriting }} {# This renders the <input type="checkbox" class="form-check-input"> #}
                        <label class="form-check-label" for="{{ form.enable_prompt_rewriting.id_for_label }}">
                            {{ form.enable_prompt_rewriting.label }}
                        </label>
                        {% if form.enable_prompt_rewriting.errors %}<div class="invalid-feedback d-block mt-1">{{ form.enable_prompt_rewriting.errors.0 }}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary btn-lg w-100 mt-3" id="generateVideoButton">
                <span class="material-icons-outlined">movie_filter</span>
                <span class="button-text">Generate Video</span>
            </button>
        </div>
    </form>

    <div id="videoStatusArea" class="mt-4">
        {% if current_job_details %}
        <div class="form-section p-3 mb-3">
            <h4 class="results-title mt-0">Video Generation Status</h4>
            <p><strong>Job ID:</strong> <code id="jobIdDisplay">{{ current_job_details.id }}</code></p>
            <p><strong>Operation Name:</strong> <code id="veoOperationNameDisplay">{{ current_job_details.veo_operation_name|default:"N/A" }}</code></p>
            <p><strong>Status:</strong> 
                <span id="jobStatusDisplay" class="badge 
                    {% if current_job_details.status == 'COMPLETED' %}bg-success
                    {% elif current_job_details.status == 'FAILED' %}bg-danger
                    {% elif current_job_details.status == 'PROCESSING' or current_job_details.status == 'PENDING' %}bg-info
                    {% else %}bg-secondary{% endif %}">
                    {{ current_job_details.get_status_display }}
                </span>
            </p>
            <div id="loadingIndicator" style="display: {% if current_job_details.status == 'PROCESSING' or current_job_details.status == 'PENDING' %}flex{% else %}none{% endif %};" class="align-items-center text-primary">
                <div class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></div>
                <strong>Processing video... Please wait. This page will auto-update.</strong>
            </div>
            {% if current_job_details.status == 'FAILED' and current_job_details.error_message %}
                <p class="text-danger mt-2"><strong>Error:</strong> {{ current_job_details.error_message }}</p>
            {% endif %}
             {% if current_job_details.status == 'COMPLETED' and not processed_video_urls and not current_job_details.error_message %}
                <p class="text-warning mt-2">Operation completed, but no video URLs were found. Check Cloud Storage output path: <code>gs://{{ gcs_bucket_name_for_display }}/{{ settings.GCS_VIDEO_OUTPUTS_PREFIX }}{{ current_job_details.id }}/</code></p>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <div id="videoResultsDisplay">
        {% if processed_video_urls %}
        <hr class="my-5">
        <h3 class="results-title mt-4">Generated Videos</h3>
        <div class="gallery-grid">
            {% for video_url in processed_video_urls %}
            <div class="gallery-item card">
                 {% if video_url and not video_url|slice:":6" == "#error" %}
                <div class="card-body p-2">
                    <video controls width="100%" style="border-radius: var(--border-radius-standard); background-color: #000;" preload="metadata">
                        <source src="{{ video_url }}" type="video/mp4">
                        Your browser does not support the video tag. Link: <a href="{{ video_url }}" target="_blank">{{ video_url }}</a>
                    </video>
                    <div class="card-actions mt-2">
                         <a href="{{ video_url }}" class="btn btn-sm btn-outline-secondary" target="_blank" rel="noopener noreferrer" title="Open Video"><span class="material-icons-outlined">open_in_new</span> View</a>
                         <button type="button" onclick="copyToClipboard('{{ video_url }}', this)" class="btn btn-sm btn-outline-secondary" title="Copy URL"><span class="material-icons-outlined">content_copy</span> Copy</button>
                    </div>
                </div>
                {% else %}
                 <div class="card-body d-flex align-items-center justify-content-center p-3" style="height: 200px;">
                    <div class="alert alert-warning m-0 text-center small">Could not load video. <br> {{ video_url }}</div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTargetInputId = null;
let currentTargetPreviewContainerId = null;
let currentTargetPreviewImgId = null;
let currentTargetFileUploadId = null;

// --- Image Preview for File Uploads ---
function setupImagePreview(uploadInputId, previewContainerId, previewImgId, mediaPathInputIdToClear) {
    const inputElement = document.getElementById(uploadInputId);
    if (!inputElement) { console.warn("Upload input not found for preview:", uploadInputId); return; }
    const previewContainer = document.getElementById(previewContainerId);
    const previewImage = document.getElementById(previewImgId);
    const mediaPathInput = document.getElementById(mediaPathInputIdToClear);

    if (previewContainer && previewImage) {
        inputElement.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                }
                reader.readAsDataURL(file);
                if (mediaPathInput) { mediaPathInput.value = ''; } // Clear media path input
                // Hide the GCS/Media Path preview if an upload is made for the same item
                const gcsPreviewContainer = document.getElementById(previewContainerId.replace('_upload_preview_container', '_gcs_preview_container'));
                if (gcsPreviewContainer) gcsPreviewContainer.style.display = 'none';
                const gcsPreviewText = document.getElementById(previewContainerId.replace('_upload_preview_container', '_gcs_preview_text'));
                 if (gcsPreviewText) gcsPreviewText.style.display = 'none';


            } else {
                previewImage.src = '#'; 
                previewContainer.style.display = 'none';
            }
        });
    }
}

function removeImagePreview(uploadInputId, previewContainerId, previewImgId, mediaPathInputIdToClear) {
    const inputElement = document.getElementById(uploadInputId);
    if (!inputElement) return;
    inputElement.value = null; 
    
    const previewContainer = document.getElementById(previewContainerId);
    const previewImage = document.getElementById(previewImgId);
    if (previewImage) previewImage.src = '#';
    if (previewContainer) previewContainer.style.display = 'none';
    
    // Optionally, re-check if a GCS path exists and show its preview if upload is removed
    const mediaPathInput = document.getElementById(mediaPathInputIdToClear);
    if (mediaPathInput && mediaPathInput.value) {
        // This would require re-fetching/re-setting the GCS preview if it was hidden
        // For now, just clears the upload. User can re-select from GCS if needed.
    }
}

function removeGCSPreview(mediaPathInputId, gcsPreviewContainerId, gcsPreviewImgId) {
    const mediaPathInput = document.getElementById(mediaPathInputId);
    if (mediaPathInput) mediaPathInput.value = '';

    const gcsPreviewContainer = document.getElementById(gcsPreviewContainerId);
    const gcsPreviewImage = document.getElementById(gcsPreviewImgId);
    const gcsPreviewText = document.getElementById(gcsPreviewContainerId.replace('_gcs_preview_container', '_gcs_preview_text'));


    if (gcsPreviewImage) gcsPreviewImage.src = '#';
    if (gcsPreviewContainer) gcsPreviewContainer.style.display = 'none';
    if (gcsPreviewText) gcsPreviewText.style.display = 'none';
}


// --- Media Selector Modal Logic ---
function openMediaSelector(targetInputId, targetGCSPreviewContainerId, targetGCSPreviewImgId, mediaType, targetFileUploadIdToClear) {
    currentTargetInputId = targetInputId;
    currentTargetPreviewContainerId = targetGCSPreviewContainerId;
    currentTargetPreviewImgId = targetGCSPreviewImgId;
    currentTargetFileUploadId = targetFileUploadIdToClear;

    const modal = new bootstrap.Modal(document.getElementById('mediaSelectorModal'));
    const gallery = document.getElementById('mediaSelectorGallery');
    const spinner = document.getElementById('mediaSelectorSpinner');
    const errorDiv = document.getElementById('mediaSelectorError');
    
    gallery.innerHTML = ''; // Clear previous items
    errorDiv.style.display = 'none';
    spinner.style.display = 'block';
    modal.show();

    fetch(`/api/list-media/?media_type=${mediaType}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Network response was not ok: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            spinner.style.display = 'none';
            if (data.error) {
                errorDiv.textContent = data.error;
                errorDiv.style.display = 'block';
                return;
            }
            if (data.media_files && data.media_files.length > 0) {
                data.media_files.forEach(item => {
                    const col = document.createElement('div');
                    col.className = 'gallery-item card media-selector-item'; // Use existing gallery styles
                    col.style.cursor = 'pointer';
                    col.dataset.gcsPath = item.gcs_path; // Full path within bucket
                    col.dataset.signedUrl = item.url;

                    let mediaElement;
                    if (item.type === 'image') {
                        mediaElement = `<img src="${item.url}" class="card-img-top" alt="${item.name}" style="height: 150px; object-fit: cover;">`;
                    } else if (item.type === 'video') {
                        mediaElement = `<video controls width="100%" style="height: 150px; background-color:#000;" preload="metadata"><source src="${item.url}" type="video/mp4"></video>`;
                    } else {
                        mediaElement = `<div class="p-2 text-muted small">Unsupported: ${item.name}</div>`;
                    }
                    col.innerHTML = `
                        ${mediaElement}
                        <div class="card-body p-1">
                            <p class="card-text small text-muted text-truncate mb-0" title="${item.name}">${item.name}</p>
                        </div>
                    `;
                    col.addEventListener('click', function() {
                        selectMedia(this.dataset.gcsPath, this.dataset.signedUrl);
                        modal.hide();
                    });
                    gallery.appendChild(col);
                });
            } else {
                gallery.innerHTML = '<p class="text-center text-muted">No media found.</p>';
            }
        })
        .catch(error => {
            spinner.style.display = 'none';
            errorDiv.textContent = `Error fetching media: ${error.message}`;
            errorDiv.style.display = 'block';
            console.error('Error fetching media for selector:', error);
        });
}

function selectMedia(gcsPath, signedUrl) {
    const targetInput = document.getElementById(currentTargetInputId);
    const targetPreviewContainer = document.getElementById(currentTargetPreviewContainerId);
    const targetPreviewImage = document.getElementById(currentTargetPreviewImgId);
    const targetPreviewText = document.getElementById(currentTargetPreviewContainerId.replace('_gcs_preview_container', '_gcs_preview_text'));

    if (targetInput) {
        // The form field 'original_image_media_path' etc. expects path relative to GCS_OBJECT_PATH_PREFIX
        // or full path if from temp etc. The gcsPath from API is full path in bucket.
        let displayPath = gcsPath;
        const mainPrefix = "{{ settings.GCS_OBJECT_PATH_PREFIX|escapejs }}"; // Get prefix from Django settings
        if (gcsPath.startsWith(mainPrefix)) {
            displayPath = gcsPath.substring(mainPrefix.length);
        }
        targetInput.value = displayPath; // Set the relative or full path as appropriate for the input field
    }
    if (targetPreviewImage && targetPreviewContainer) {
        targetPreviewImage.src = signedUrl;
        targetPreviewContainer.style.display = 'block';
        if (targetPreviewText) targetPreviewText.style.display = 'block';
    }
    // Clear the corresponding file upload input
    if(currentTargetFileUploadId) {
        const fileUploadInput = document.getElementById(currentTargetFileUploadId);
        if(fileUploadInput) fileUploadInput.value = null; // Clear file selection
        // Also hide its direct upload preview
        const uploadPreviewContainerId = currentTargetFileUploadId.replace('id_', '') + '_preview_container';
        const uploadPreviewContainer = document.getElementById(uploadPreviewContainerId);
        if (uploadPreviewContainer) uploadPreviewContainer.style.display = 'none';
        const uploadPreviewImgId = currentTargetFileUploadId.replace('id_', '') + '_preview';
        const uploadPreviewImg = document.getElementById(uploadPreviewImgId);
        if (uploadPreviewImg) uploadPreviewImg.src = '#';

    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Ensure global functions from base.html are loaded, or define them here if they were local to edit.html
    if (typeof setupImagePreview !== "function" || 
        typeof removeImagePreview !== "function" || 
        typeof removeGCSPreview !== "function" ||
        typeof openMediaSelector !== "function") {
        console.error("Core preview and modal functions are not defined. Ensure base.html includes them or copy them here from your working edit.html script block.");
        // If these are not in base.html, you need to PASTE their definitions here from your working edit.html
    }

    // Setup preview for the "Initial Image" upload field on THIS page
    const videoFormInputUploadId = '{{ form.input_image_upload.id_for_label }}'; // ID for the file input
    const videoFormInputMediaPathId = '{{ form.input_image_media_path.id_for_label }}'; // ID for the text input (media path)

    if (document.getElementById(videoFormInputUploadId)) {
        setupImagePreview(
            videoFormInputUploadId, 
            'input_image_upload_preview_container', // Preview container for upload
            'input_image_upload_preview',           // Img tag for upload preview
            videoFormInputMediaPathId               // Media path input to clear if file is uploaded
        );
    }
    
    // Clear file upload if Media Path for initial video image is typed into
    const mediaPathInputForVideo = document.getElementById(videoFormInputMediaPathId);
    if (mediaPathInputForVideo && document.getElementById(videoFormInputUploadId)) { 
        mediaPathInputForVideo.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                // Clear the file upload and its preview
                removeImagePreview(
                    videoFormInputUploadId, 
                    'input_image_upload_preview_container', 
                    'input_image_upload_preview'
                );
                // Also hide the GCS/Media path preview that might have been loaded from session/GET param,
                // as the user is now overriding with a typed path.
                removeGCSPreview(
                    videoFormInputMediaPathId, 
                    'input_image_gcs_preview_container', 
                    'input_image_gcs_preview'
                );
            }
        });
    }
    
    // Video job polling logic (as previously provided and confirmed working)
    const jobIdForPolling = "{{ job_id_for_polling|escapejs }}";
    // ... (full polling JavaScript for video status and results display)
    const jobStatusDisplay = document.getElementById('jobStatusDisplay');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const videoResultsDisplay = document.getElementById('videoResultsDisplay');
    const veoOpNameDisplay = document.getElementById('veoOperationNameDisplay'); 

    if (jobIdForPolling && jobStatusDisplay && (jobStatusDisplay.textContent.trim().toUpperCase() === 'PROCESSING' || jobStatusDisplay.textContent.trim().toUpperCase() === 'PENDING')) {
        if(loadingIndicator) loadingIndicator.style.display = 'flex';
        
        let pollCount = 0;
        const maxPolls = 120; 
        let pollInterval = setInterval(function() {
            pollCount++;
            if (pollCount > maxPolls) {
                clearInterval(pollInterval);
                if(loadingIndicator) {
                    loadingIndicator.innerHTML = '<strong>Processing is taking longer than expected. Please check the "Browse" page or your Cloud Storage later.</strong>';
                    loadingIndicator.classList.remove('text-primary');
                    loadingIndicator.classList.add('text-warning');
                }
                const submitButton = document.getElementById('generateVideoButton');
                if(submitButton) { 
                    submitButton.disabled = false; 
                    const btnText = submitButton.querySelector('.button-text'); 
                    if(btnText) btnText.textContent = 'Generate Video'; 
                    else { /* Fallback for button text if .button-text span was removed */ }
                }
                return;
            }

            fetch(`/video/status/${jobIdForPolling}/`)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`); }
                    return response.json();
                })
                .then(data => {
                    // ... (Update status display, handle COMPLETED/FAILED, render videos - as before) ...
                })
                .catch(error => {
                    // ... (Error handling for polling - as before) ...
                });
        }, 7000); 
    }
});
</script>
{% endblock %}